
// ============================================
// GLOBAL VARIABLES
// ============================================

let menuData = [];
let currentOrders = [];
let currentSession = null;
let currentUser = localStorage.getItem('userName') || '';

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', function() {
  // Check if user name is already set
  if (currentUser) {
    document.getElementById('userNameDisplay').textContent = currentUser;
    document.getElementById('userSetupCard').style.display = 'none';
    initializeApp();
  } else {
    document.getElementById('userNameInput').focus();
  }
});

function setUserName() {
  const userName = document.getElementById('userNameInput').value.trim();

  if (!userName) {
    alert('Please enter your name');
    return;
  }

  currentUser = userName;
  localStorage.setItem('userName', userName);
  document.getElementById('userNameDisplay').textContent = userName;
  document.getElementById('userSetupCard').style.display = 'none';

  initializeApp();
}

function initializeApp() {
  showLoading();

  // Get or create active session
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        currentSession = result.session || result;
        loadMenu();
      } else {
        hideLoading();
        showError('Failed to initialize session: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('Error: ' + error.message);
    })
    .getActiveSession();
}

// ============================================
// MENU FUNCTIONS
// ============================================

function loadMenu() {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        menuData = result.data;
        renderMenu(menuData);
        populateFilters();
        loadOrders();
      } else {
        hideLoading();
        showError('Failed to load menu: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('Error loading menu: ' + error.message);
    })
    .getMenuData();
}

function renderMenu(items) {
  const container = document.getElementById('menuContainer');

  if (items.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="bi bi-search"></i>
        <p class="mt-3">No items found</p>
      </div>
    `;
    return;
  }

  // Group items by category
  const groupedItems = items.reduce((acc, item) => {
    if (!acc[item.category]) {
      acc[item.category] = [];
    }
    acc[item.category].push(item);
    return acc;
  }, {});

  let html = '';

  for (const [category, categoryItems] of Object.entries(groupedItems)) {
    html += `
      <div class="menu-category">
        <h3 class="category-title">${category}</h3>
        <div class="row">
    `;

    categoryItems.forEach(item => {
      const vegBadge = item.vegetarian 
        ? '<span class="veg-badge"></span>' 
        : '<span class="nonveg-badge"></span>';

      html += `
        <div class="col-md-6 mb-3">
          <div class="card menu-item">
            <div class="menu-item-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="flex-grow-1">
                  <div class="item-name">
                    ${vegBadge}
                    ${item.name}
                  </div>
                  <div class="item-description">${item.description}</div>
                </div>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <div class="item-price">₹${item.price}</div>
                <div class="quantity-controls">
                  <button class="btn btn-sm btn-outline-secondary" onclick="decrementQuantity(${item.id})">
                    <i class="bi bi-dash"></i>
                  </button>
                  <input type="number" class="quantity-input" id="qty-${item.id}" value="1" min="1" max="99">
                  <button class="btn btn-sm btn-outline-secondary" onclick="incrementQuantity(${item.id})">
                    <i class="bi bi-plus"></i>
                  </button>
                  <button class="btn btn-sm btn-primary" onclick="addToOrder(${item.id})">
                    <i class="bi bi-cart-plus"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    });

    html += `
        </div>
      </div>
    `;
  }

  container.innerHTML = html;
  hideLoading();
}

function populateFilters() {
  const categories = [...new Set(menuData.map(item => item.category))];
  const categoryFilter = document.getElementById('categoryFilter');

  categoryFilter.innerHTML = '<option value="">All Categories</option>';
  categories.forEach(category => {
    categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
  });
}

function filterMenu() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const categoryFilter = document.getElementById('categoryFilter').value;
  const typeFilter = document.getElementById('typeFilter').value;

  const filteredItems = menuData.filter(item => {
    const matchesSearch = item.name.toLowerCase().includes(searchTerm) || 
                          item.description.toLowerCase().includes(searchTerm);
    const matchesCategory = !categoryFilter || item.category === categoryFilter;
    const matchesType = !typeFilter || 
                        (typeFilter === 'veg' && item.vegetarian) || 
                        (typeFilter === 'nonveg' && !item.vegetarian);

    return matchesSearch && matchesCategory && matchesType;
  });

  renderMenu(filteredItems);
}

// ============================================
// QUANTITY CONTROLS
// ============================================

function incrementQuantity(itemId) {
  const input = document.getElementById(`qty-${itemId}`);
  const currentValue = parseInt(input.value) || 1;
  input.value = Math.min(currentValue + 1, 99);
}

function decrementQuantity(itemId) {
  const input = document.getElementById(`qty-${itemId}`);
  const currentValue = parseInt(input.value) || 1;
  input.value = Math.max(currentValue - 1, 1);
}


// ============================================
// ORDER FUNCTIONS
// ============================================

function addToOrder(itemId) {
  if (!currentUser) {
    alert('Please enter your name first');
    return;
  }

  if (!currentSession || !currentSession.sessionId) {
    alert('Session not initialized. Please refresh the page.');
    return;
  }

  const item = menuData.find(i => i.id === itemId);
  if (!item) {
    alert('Item not found');
    return;
  }

  const quantityInput = document.getElementById(`qty-${itemId}`);
  const quantity = parseInt(quantityInput.value) || 1;

  const orderData = {
    sessionId: currentSession.sessionId,
    userName: currentUser,
    itemId: item.id,
    itemName: item.name,
    category: item.category,
    quantity: quantity,
    pricePerItem: item.price,
    totalPrice: item.price * quantity
  };

  showLoading();

  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        showSuccess('Added to order!');
        quantityInput.value = 1; // Reset quantity
        loadOrders(); // Refresh orders
      } else {
        showError('Failed to add order: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('Error: ' + error.message);
    })
    .addOrder(orderData);
}

function loadOrders() {
  if (!currentSession || !currentSession.sessionId) {
    return;
  }

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        currentOrders = result.data;
        renderOrders(currentOrders);
        updateStats(currentOrders);
      } else {
        showError('Failed to load orders: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      showError('Error loading orders: ' + error.message);
    })
    .getAllOrders(currentSession.sessionId);
}

function renderOrders(orders) {
  const container = document.getElementById('ordersList');

  if (orders.length === 0) {
    container.innerHTML = `
      <div class="text-center text-muted py-5">
        <i class="bi bi-cart-x" style="font-size: 3rem;"></i>
        <p class="mt-2">No orders yet</p>
      </div>
    `;
    return;
  }

  let html = '';

  orders.forEach(order => {
    const statusClass = order.status === 'Served' ? 'status-served' : 
                       order.status === 'Not Available' ? 'status-cancelled' : 
                       'status-ordered';

    html += `
      <div class="order-item">
        <div class="order-item-header">
          <div class="flex-grow-1">
            <div class="order-item-name">${order.itemName}</div>
            <div class="order-item-details">
              <small class="text-muted">
                <i class="bi bi-person"></i> ${order.userName} • 
                Qty: ${order.quantity} • 
                ₹${order.totalPrice}
              </small>
            </div>
          </div>
          <span class="badge ${statusClass}">${order.status}</span>
        </div>
        <div class="order-item-actions">
    `;

    if (order.status === 'Ordered') {
      html += `
        <button class="btn btn-sm btn-success" onclick="markAsServed('${order.orderId}')">
          <i class="bi bi-check-circle"></i> Served
        </button>
        <button class="btn btn-sm btn-danger" onclick="markAsNotAvailable('${order.orderId}')">
          <i class="bi bi-x-circle"></i> Not Available
        </button>
      `;
    }

    if (order.status === 'Not Available' || order.userName === currentUser) {
      html += `
        <button class="btn btn-sm btn-outline-danger" onclick="deleteOrder('${order.orderId}')">
          <i class="bi bi-trash"></i> Remove
        </button>
      `;
    }

    html += `
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
}

function updateStats(orders) {
  let totalItems = 0;
  let totalAmount = 0;
  let orderedCount = 0;
  let servedCount = 0;
  let cancelledCount = 0;

  orders.forEach(order => {
    totalItems += order.quantity;

    if (order.status !== 'Not Available') {
      totalAmount += order.totalPrice;
    }

    if (order.status === 'Ordered') orderedCount++;
    if (order.status === 'Served') servedCount++;
    if (order.status === 'Not Available') cancelledCount++;
  });

  document.getElementById('totalItemsCount').textContent = totalItems;
  document.getElementById('totalAmount').textContent = '₹' + totalAmount;
  document.getElementById('orderedCount').textContent = orderedCount;
  document.getElementById('servedCount').textContent = servedCount;
  document.getElementById('cancelledCount').textContent = cancelledCount;
}

function markAsServed(orderId) {
  showLoading();

  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        showSuccess('Marked as served!');
        loadOrders();
      } else {
        showError('Failed to update: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('Error: ' + error.message);
    })
    .updateOrderStatus(orderId, 'Served', '');
}

function markAsNotAvailable(orderId) {
  if (!confirm('Mark this item as not available? It will be excluded from the final bill.')) {
    return;
  }

  showLoading();

  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        showSuccess('Marked as not available');
        loadOrders();
      } else {
        showError('Failed to update: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('Error: ' + error.message);
    })
    .updateOrderStatus(orderId, 'Not Available', 'Item not available');
}

function deleteOrder(orderId) {
  if (!confirm('Are you sure you want to remove this order?')) {
    return;
  }

  showLoading();

  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        showSuccess('Order removed');
        loadOrders();
      } else {
        showError('Failed to delete: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('Error: ' + error.message);
    })
    .deleteOrder(orderId);
}


// ============================================
// BILL MODAL FUNCTIONS
// ============================================

function showBillModal() {
  if (!currentSession || !currentSession.sessionId) {
    alert('No active session');
    return;
  }

  showLoading();

  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        renderBillSummary(result);
        const modal = new bootstrap.Modal(document.getElementById('billModal'));
        modal.show();
      } else {
        showError('Failed to calculate bill: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('Error: ' + error.message);
    })
    .calculateBill(currentSession.sessionId);
}

function renderBillSummary(billData) {
  const summary = billData.summary;
  const orders = billData.orders;

  let html = `
    <div class="bill-section">
      <h5><i class="bi bi-info-circle"></i> Session Details</h5>
      <p class="mb-1"><strong>Session:</strong> ${currentSession.sessionName || 'Dinner Session'}</p>
      <p class="mb-0"><strong>Date:</strong> ${new Date().toLocaleDateString('en-IN', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })}</p>
    </div>

    <div class="bill-section">
      <h5><i class="bi bi-receipt"></i> Order Summary</h5>
      <table class="table table-sm bill-table">
        <thead>
          <tr>
            <th>Item</th>
            <th>Person</th>
            <th>Qty</th>
            <th>Price</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
  `;

  orders.forEach(order => {
    const statusBadge = order.status === 'Served' ? 'bg-success' : 
                       order.status === 'Not Available' ? 'bg-danger' : 'bg-warning text-dark';

    html += `
      <tr>
        <td>${order.itemName}</td>
        <td>${order.userName}</td>
        <td>${order.quantity}</td>
        <td>₹${order.totalPrice}</td>
        <td><span class="badge ${statusBadge}">${order.status}</span></td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
    </div>

    <div class="bill-section">
      <h5><i class="bi bi-people"></i> Split by Person</h5>
      <table class="table table-sm bill-table">
        <thead>
          <tr>
            <th>Person</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody>
  `;

  for (const [person, amount] of Object.entries(summary.byPerson)) {
    html += `
      <tr>
        <td>${person}</td>
        <td>₹${amount}</td>
      </tr>
    `;
  }

  html += `
        </tbody>
      </table>
    </div>

    <div class="bill-section">
      <h5><i class="bi bi-bar-chart"></i> By Category</h5>
      <table class="table table-sm bill-table">
        <thead>
          <tr>
            <th>Category</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody>
  `;

  for (const [category, amount] of Object.entries(summary.byCategory)) {
    html += `
      <tr>
        <td>${category}</td>
        <td>₹${amount}</td>
      </tr>
    `;
  }

  html += `
        </tbody>
      </table>
    </div>

    <div class="bill-total">
      <div class="row">
        <div class="col-6">
          <div class="mb-2">
            <strong>Total Items:</strong> ${summary.totalItems}
          </div>
          <div class="mb-2">
            <strong>Served Amount:</strong> <span class="text-success">₹${summary.servedAmount}</span>
          </div>
          <div class="mb-2">
            <strong>Pending:</strong> <span class="text-warning">₹${summary.pendingAmount}</span>
          </div>
          <div>
            <strong>Not Available:</strong> <span class="text-danger">₹${summary.cancelledAmount}</span>
          </div>
        </div>
        <div class="col-6 text-end">
          <div class="text-muted mb-1">Expected Bill Amount</div>
          <div class="h3 text-primary mb-0">₹${summary.servedAmount}</div>
          <small class="text-muted">(excluding unavailable items)</small>
        </div>
      </div>
    </div>

    <div class="alert alert-info mt-3">
      <i class="bi bi-info-circle"></i> 
      <strong>Note:</strong> Cross-check this amount with the restaurant bill. 
      Items marked as "Not Available" are excluded from the total.
    </div>
  `;

  document.getElementById('billContent').innerHTML = html;
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function showLoading() {
  // Simple loading implementation - you can enhance this
  document.body.style.cursor = 'wait';
}

function hideLoading() {
  document.body.style.cursor = 'default';
}

function showSuccess(message) {
  // Simple alert - you can replace with toast notifications
  console.log('Success:', message);
  // Optional: Implement toast notification here
}

function showError(message) {
  alert('Error: ' + message);
  console.error('Error:', message);
}

// Auto-refresh orders every 10 seconds
setInterval(function() {
  if (currentSession && currentSession.sessionId && currentUser) {
    loadOrders();
  }
}, 10000);
